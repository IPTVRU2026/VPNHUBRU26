name: ğŸ§Š ICEBREAKER - Ultimate Auto-Deploying System

on:
  schedule:
    - cron: '0 * * * *'   # ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ñ‡Ğ°Ñ
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write       # Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ´Ğ»Ñ Ñ‚ĞµĞ³Ğ¾Ğ², Ñ€ĞµĞ»Ğ¸Ğ·Ğ¾Ğ², push Ğ² gh-pages
  pages: write          # Ğ´Ğ»Ñ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ Ğ½Ğ° GitHub Pages
  id-token: write       # Ğ´Ğ»Ñ OIDC / Pages deployment (Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚)

env:
  TG_API_ID: "38922115"
  TG_API_HASH: "b34ae241317eff8743f538a8272c5f6d"

jobs:
  icebreaker:
    runs-on: ubuntu-latest

    steps:
    - name: â¬‡ï¸ Checkout
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install telethon pyrogram tgcrypto aiohttp beautifulsoup4 requests lxml qrcode pillow

    - name: ğŸ“ Prepare Directories & .gitignore
      run: |
        mkdir -p output/{telegram,vpn,raw,qr} logs sessions site scripts
        echo "sessions/" >> .gitignore
        echo "*.session" >> .gitignore
        echo "output/" >> .gitignore   # Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ â€” ĞµÑĞ»Ğ¸ Ğ½Ğµ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ¸Ñ‚ÑŒ ÑÑ‹Ñ€Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹

    - name: ğŸ“ Create All Scripts
      run: |
        # ==================== BOT INFILTRATOR ====================
        cat > scripts/bot_infiltrator.py << 'EOF'
        #!/usr/bin/env python3
        import asyncio
        import random
        import json
        import re
        import logging
        from datetime import datetime
        from telethon import TelegramClient, events
        from telethon.errors import FloodWaitError
        from telethon.tl.functions.messages import GetBotCallbackAnswerRequest
        from telethon.tl.types import KeyboardButtonCallback, KeyboardButtonUrl
        
        API_ID = int("38922115")
        API_HASH = "b34ae241317eff8743f538a8272c5f6d"
        
        TARGET_BOTS = [
            "@MTProtoProxybot", "@ProxyMTProtoBot", "@socks5_bot", "@vmess_vless_bot",
            "@FreeVPNbot", "@v2ray_config_bot", "@shadowsocks_bot", "@proxytelegrambot",
            "@vpnconfig_bot", "@proxy_seller_bot"
        ]
        
        CONFIG_PATTERNS = {
            'tg_proxy': re.compile(r'(tg://proxy\?[^\s]+)'),
            'vless':    re.compile(r'(vless://[^\s]+)'),
            'vmess':    re.compile(r'(vmess://[^\s]+)'),
            'ss':       re.compile(r'(ss://[^\s]+)'),
            'trojan':   re.compile(r'(trojan://[^\s]+)'),
        }
        
        logging.basicConfig(level=logging.INFO, format='%(asctime)s %(levelname)s %(message)s')
        logger = logging.getLogger(__name__)
        
        class BotInfiltrator:
            def __init__(self):
                self.client = TelegramClient("sessions/icebreaker_bot", API_ID, API_HASH)
                self.configs = {'telegram': [], 'vpn': [], 'raw': []}
        
            async def safe_sleep(self, sec_range=(1, 4)):
                await asyncio.sleep(random.uniform(*sec_range))
        
            async def extract(self, text, source, method):
                for typ, pat in CONFIG_PATTERNS.items():
                    for m in pat.findall(text):
                        data = {
                            'config': m.strip(),
                            'type': typ,
                            'source': source,
                            'method': method,
                            'time': datetime.utcnow().isoformat() + "Z"
                        }
                        if data not in self.configs['raw']:
                            self.configs['raw'].append(data)
                            if typ == 'tg_proxy':
                                if data not in self.configs['telegram']:
                                    self.configs['telegram'].append(data)
                                    logger.info(f"TG proxy found: {m[:60]}...")
                            else:
                                if data not in self.configs['vpn']:
                                    self.configs['vpn'].append(data)
                                    logger.info(f"VPN config found: {m[:60]}...")
        
            async def strategy_direct(self, bot):
                try:
                    await self.client.send_message(bot, '/start')
                    await self.safe_sleep()
                    async for m in self.client.iter_messages(bot, limit=6):
                        if m.text: await self.extract(m.text, bot, "direct")
                except FloodWaitError as e:
                    logger.warning(f"Flood wait {e.seconds}s")
                    await asyncio.sleep(e.seconds + 5)
                except Exception as e:
                    logger.debug(f"direct failed {bot}: {e}")
        
            # ... (Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ğ¸ Ğ°Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ğ¾ Ñ try/except + FloodWaitError Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¾Ğ¹)
            # Ğ´Ğ»Ñ ĞºÑ€Ğ°Ñ‚ĞºĞ¾ÑÑ‚Ğ¸ Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ´Ğ½Ñƒ â€” Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ¾ Ğ°Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ğ¸
        
            async def attack(self, bot):
                logger.info(f"â†’ Attacking {bot}")
                strategies = [self.strategy_direct]  # Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ
                for strat in strategies:
                    try:
                        await strat(bot)
                        await self.safe_sleep((3, 8))
                    except Exception as e:
                        logger.debug(f"strat failed: {e}")
        
            async def run(self):
                await self.client.connect()
                if not await self.client.is_user_authorized():
                    logger.error("Session not authorized â€” manual login required first time")
                    return
                for bot in TARGET_BOTS:
                    await self.attack(bot)
                    await self.safe_sleep((6, 12))
                await self.client.disconnect()
        
                # ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ
                with open('output/telegram/from_bots.txt', 'w', encoding='utf-8') as f:
                    for c in self.configs['telegram']:
                        f.write(c['config'] + '\n')
                with open('output/vpn/from_bots.json', 'w', encoding='utf-8') as f:
                    json.dump(self.configs['vpn'], f, ensure_ascii=False, indent=2)
        
                logger.info(f"Done. TG: {len(self.configs['telegram'])}, VPN: {len(self.configs['vpn'])}")
        
        if __name__ == '__main__':
            asyncio.run(BotInfiltrator().run())
        EOF

        # ĞĞ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ğ¾ Ğ¿ĞµÑ€ĞµĞ¿Ğ¸ÑˆĞ¸ tg_monitor.py Ğ¸ web_crawler.py Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¾Ğ¹ FloodWaitError
        # Ğ¸ random sleep Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°Ğ¼Ğ¸

        # merge.py Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ñ‡Ñ‚Ğ¸ Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹

        chmod +x scripts/*.py

    - name: ğŸ¤– Run Bot Infiltrator
      timeout-minutes: 25
      run: python scripts/bot_infiltrator.py || echo "Bot step failed (possibly flood)"

    - name: ğŸ“¡ Run Channel Monitor
      timeout-minutes: 20
      run: python scripts/tg_monitor.py || true

    - name: ğŸ•¸ï¸ Run Web Crawler
      timeout-minutes: 20
      run: python scripts/web_crawler.py || true

    - name: ğŸ”„ Merge & Prepare Artifacts
      run: python scripts/merge.py

    - name: ğŸŒ Generate & Commit Website
      run: |
        # Ñ‚Ğ²Ğ¾Ğ¹ python-ĞºĞ¾Ğ´ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ index.html Ğ¾ÑÑ‚Ğ°Ñ‘Ñ‚ÑÑ
        # ...

    - name: ğŸ“Š Collect Stats
      id: stats
      run: |
        TG_COUNT=$(wc -l < output/telegram/telegram_proxies.txt 2>/dev/null || echo 0)
        VPN_COUNT=$(jq '. | length' output/vpn/vpn_configs.json 2>/dev/null || echo 0)
        echo "tg_count=$TG_COUNT"   >> $GITHUB_OUTPUT
        echo "vpn_count=$VPN_COUNT" >> $GITHUB_OUTPUT
        echo "timestamp=$(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_OUTPUT

    - name: ğŸ“¦ Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: update-${{ steps.stats.outputs.timestamp }}
        name: Update ${{ steps.stats.outputs.timestamp }}
        body_path: notes.md
        files: |
          output/telegram/telegram_proxies.txt
          output/vpn/vpn_configs.json
          output/raw/all_in_one.txt
          output/raw/subscription.txt
        generate_release_notes: false
        make_latest: true

    - name: ğŸŒ Deploy GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./site
        user_name: 'ICEBREAKER Bot'
        user_email: 'bot@icebreaker.auto'
        commit_message: 'Deploy ICEBREAKER website ${{ steps.stats.outputs.timestamp }}'

    - name: ğŸ‰ Summary
      run: |
        echo "ICEBREAKER finished"
        echo "Telegram proxies : ${{ steps.stats.outputs.tg_count }}"
        echo "VPN configs      : ${{ steps.stats.outputs.vpn_count }}"
